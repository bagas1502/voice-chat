<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Voice Chat</title>
</head>
<body>
  <h2>üî• Voice Chat Room</h2>

  <div>
    <label>–í–≤–µ–¥–∏—Ç–µ –∏–º—è: </label>
    <input id="username" placeholder="–í–∞—à–µ –∏–º—è">
    <button id="joinBtn">Join Chat</button>
  </div>

  <h3>üë• –°–µ–π—á–∞—Å –≤ —á–∞—Ç–µ:</h3>
  <ul id="users"></ul>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let peers = {};
    let localStream;

    document.getElementById("joinBtn").onclick = async () => {
      const name = document.getElementById("username").value || "–ì–æ—Å—Ç—å";
      socket.emit("join", name);

      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    };

    // —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    socket.on("user-list", (list) => {
      const ul = document.getElementById("users");
      ul.innerHTML = "";
      list.forEach(user => {
        const li = document.createElement("li");
        li.innerText = user;
        ul.appendChild(li);
      });
    });

    // —Å–∏–≥–Ω–∞–ª–∏–Ω–≥ –¥–ª—è WebRTC
    socket.on("signal", async (data) => {
      if (!peers[data.sender]) {
        const peer = new RTCPeerConnection();
        peers[data.sender] = peer;

        localStream.getTracks().forEach(track => peer.addTrack(track, localStream));

        peer.ontrack = (event) => {
          const audio = document.createElement("audio");
          audio.srcObject = event.streams[0];
          audio.autoplay = true;
          document.body.appendChild(audio);
        };

        peer.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit("signal", { target: data.sender, signal: event.candidate });
          }
        };
      }

      const peer = peers[data.sender];
      if (data.signal.type === "offer") {
        await peer.setRemoteDescription(new RTCSessionDescription(data.signal));
        const answer = await peer.createAnswer();
        await peer.setLocalDescription(answer);
        socket.emit("signal", { target: data.sender, signal: peer.localDescription });
      } else if (data.signal.type === "answer") {
        await peer.setRemoteDescription(new RTCSessionDescription(data.signal));
      } else if (data.signal.candidate) {
        await peer.addIceCandidate(new RTCIceCandidate(data.signal));
      }
    });
  </script>
</body>
</html>
